# 출퇴근 자동 처리 스케줄러

## 개요
DB가 계속 돌아가면서 **자동으로 결근/퇴근을 처리**하는 스케줄러입니다.  
출근 시간대에 출근하지 않으면 자동으로 결근 처리되고, 퇴근을 안 찍으면 자동으로 퇴근 처리됩니다.

## 🕐 스케줄러 동작 시간

### 1️⃣ 자동 결근 처리
**실행 시간:** 매일 **오전 10시 01분** (평일만)

**동작:**
- 오전 10시까지 출근하지 않은 직원 자동 결근 처리
- `AttendanceType.ABSENT`로 기록
- 근무시간 0시간으로 기록

**조건:**
- 평일(월~금)에만 실행
- 주말(토, 일)은 자동 실행 안 함
- 오늘 날짜 00:00 ~ 23:59 사이 출근 기록이 없는 직원 대상

### 2️⃣ 자동 퇴근 처리
**실행 시간:** 매일 **밤 11시 50분** (평일만)

**동작:**
- 출근했지만 퇴근을 안 찍은 직원 자동 퇴근 처리
- 퇴근 시간: 23:50으로 기록
- 근무시간 자동 계산 (출근시간 ~ 23:50)
- 초과근무 자동 계산 (8시간 초과분)

**조건:**
- 평일(월~금)에만 실행
- 주말(토, 일)은 자동 실행 안 함
- 결근, 휴가 상태는 제외

### 3️⃣ 근무 상태 체크 (선택사항)
**실행 시간:** 매시간 **정각** (평일만)

**동작:**
- 현재 근무 중인 직원 수 로깅
- 오늘 출근한 전체 직원 수 로깅
- 모니터링 용도

## 📋 기준 시간

| 항목 | 시간 | 설명 |
|-----|------|------|
| 출근 시작 시간 | 09:00 | 정상 출근 시간 |
| 출근 마감 시간 | 10:00 | 이 시간까지 출근 안 하면 결근 |
| 퇴근 시간 | 18:00 | 정상 퇴근 시간 |
| 자동 퇴근 시간 | 23:50 | 퇴근 안 찍은 직원 자동 처리 |

## 🔄 Cron 표현식

```java
// 자동 결근 처리: 평일 오전 10시 1분
@Scheduled(cron = "0 1 10 * * MON-FRI")

// 자동 퇴근 처리: 평일 밤 11시 50분
@Scheduled(cron = "0 50 23 * * MON-FRI")

// 근무 상태 체크: 평일 매시간 정각
@Scheduled(cron = "0 0 * * * MON-FRI")
```

### Cron 패턴 설명
```
0 1 10 * * MON-FRI
│ │ │  │ │ └─────── 요일 (MON-FRI: 월~금)
│ │ │  │ └───────── 월 (* : 모든 월)
│ │ │  └─────────── 일 (* : 모든 일)
│ │ └────────────── 시간 (10: 오전 10시)
│ └──────────────── 분 (1: 1분)
└────────────────── 초 (0: 0초)
```

## 💡 동작 예시

### 시나리오 1: 정상 출근/퇴근
```
09:00 - 김철수 출근 ✅
18:00 - 김철수 퇴근 ✅
10:01 - [스케줄러] 결근 체크 → 김철수 정상 출근 확인 ✅
23:50 - [스케줄러] 퇴근 체크 → 김철수 이미 퇴근함 ✅
```

### 시나리오 2: 출근 안 함 (결근)
```
10:01 - [스케줄러] 결근 체크 
        → 김철수 출근 기록 없음
        → 자동 결근 처리 ❌
        → Attendance 레코드 생성:
           - checkIn: 2025-01-15 10:00
           - checkOut: null
           - attendanceType: ABSENT
           - note: "자동 결근 처리 (출근 기록 없음)"
           - workHours: 0.0
```

### 시나리오 3: 퇴근 안 찍음
```
09:00 - 김철수 출근 ✅
       (퇴근 깜빡함...)
23:50 - [스케줄러] 퇴근 체크
        → 김철수 퇴근 기록 없음
        → 자동 퇴근 처리 🏁
        → Attendance 업데이트:
           - checkOut: 2025-01-15 23:50
           - workHours: 14.8시간
           - overtimeHours: 6.8시간 (8시간 초과분)
```

### 시나리오 4: 지각
```
09:30 - 김철수 출근 (지각) ⚠️
18:00 - 김철수 퇴근 ✅
10:01 - [스케줄러] 결근 체크 → 출근 기록 있음 (건너뜀)
23:50 - [스케줄러] 퇴근 체크 → 이미 퇴근함 (건너뜀)
```

## 📊 로그 예시

### 자동 결근 처리 로그
```
2025-01-15 10:01:00 INFO  🔄 자동 결근 처리 스케줄러 시작
2025-01-15 10:01:02 INFO  ❌ [결근] 김철수 (ID: 12341) - 출근 기록 없음
2025-01-15 10:01:02 INFO  ❌ [결근] 박영희 (ID: 12342) - 출근 기록 없음
2025-01-15 10:01:03 INFO  ✅ 자동 결근 처리 완료: 2명 결근 처리됨
```

### 자동 퇴근 처리 로그
```
2025-01-15 23:50:00 INFO  🔄 자동 퇴근 처리 스케줄러 시작
2025-01-15 23:50:01 INFO  🏁 [자동퇴근] 김철수 (ID: 12341) - 14.8시간 근무
2025-01-15 23:50:02 INFO  ✅ 자동 퇴근 처리 완료: 1명 자동 퇴근됨
```

### 근무 상태 체크 로그
```
2025-01-15 09:00:00 INFO  📊 [09:00] 현재 근무 중: 5명 | 총 출근: 5명
2025-01-15 10:00:00 INFO  📊 [10:00] 현재 근무 중: 18명 | 총 출근: 18명
2025-01-15 12:00:00 INFO  📊 [12:00] 현재 근무 중: 20명 | 총 출근: 20명
2025-01-15 18:00:00 INFO  📊 [18:00] 현재 근무 중: 3명 | 총 출근: 20명
```

## 🎯 데이터베이스 영향

### 자동 결근 처리 시 INSERT
```sql
INSERT INTO attendance (
    employee_id, 
    check_in, 
    check_out, 
    attendance_type, 
    note, 
    work_hours, 
    overtime_hours
) VALUES (
    12341,                                    -- 직원 ID
    '2025-01-15 10:00:00',                   -- 마감 시간
    NULL,                                     -- 퇴근 없음
    'ABSENT',                                 -- 결근
    '자동 결근 처리 (출근 기록 없음)',        -- 메모
    0.0,                                      -- 근무시간 0
    0.0                                       -- 초과근무 0
);
```

### 자동 퇴근 처리 시 UPDATE
```sql
UPDATE attendance 
SET 
    check_out = '2025-01-15 23:50:00',       -- 자동 퇴근 시간
    work_hours = 14.8,                        -- 계산된 근무시간
    overtime_hours = 6.8                      -- 초과근무 (14.8 - 8)
WHERE 
    id = 123 
    AND check_out IS NULL;                    -- 퇴근 안 한 레코드만
```

## ⚙️ 설정 변경 방법

### 시간 변경
`AttendanceScheduler.java` 파일에서 상수 변경:

```java
// 출근 마감 시간을 10:00 → 09:30으로 변경
private static final LocalTime CHECK_IN_DEADLINE = LocalTime.of(9, 30);

// 자동 퇴근 시간을 23:50 → 22:00으로 변경
private static final LocalTime AUTO_CHECKOUT_TIME = LocalTime.of(22, 0);
```

### Cron 변경
```java
// 자동 결근 처리 시간을 10:01 → 09:31로 변경
@Scheduled(cron = "0 31 9 * * MON-FRI")

// 자동 퇴근 처리 시간을 23:50 → 22:00으로 변경
@Scheduled(cron = "0 0 22 * * MON-FRI")
```

### 주말 포함하려면
```java
// 평일만: MON-FRI
@Scheduled(cron = "0 1 10 * * MON-FRI")

// 주말 포함: *
@Scheduled(cron = "0 1 10 * * *")

// 토요일만 추가: MON-SAT
@Scheduled(cron = "0 1 10 * * MON-SAT")
```

## 🚨 주의사항

1. **타임존 확인**
   - 서버 시간이 한국 시간(KST)인지 확인
   - UTC인 경우 9시간 차이 발생

2. **데이터 정합성**
   - 수동으로 결근/퇴근 처리한 경우 스케줄러가 중복 처리하지 않음
   - 이미 레코드가 있으면 건너뜀

3. **휴가자 제외**
   - `AttendanceType.LEAVE`는 결근 처리 안 함
   - 휴가는 별도 시스템에서 관리

4. **공휴일 처리**
   - 현재는 평일 기준으로만 동작
   - 공휴일 DB 추가 시 별도 로직 필요

## 🧪 테스트 방법

### 1. 수동 실행 (개발용)
스케줄러 메서드를 직접 호출:
```java
@Autowired
private AttendanceScheduler scheduler;

// 결근 처리 테스트
scheduler.autoMarkAbsent();

// 퇴근 처리 테스트
scheduler.autoCheckOut();
```

### 2. Cron 시간 변경해서 테스트
```java
// 1분 후 실행되도록 설정
@Scheduled(cron = "0 * * * * *") // 매분마다 실행
```

### 3. 로그 확인
```bash
# 로그 파일 확인 (Linux/Mac)
tail -f logs/application.log | grep "스케줄러"

# 특정 시간대 로그 확인
grep "10:01" logs/application.log
grep "23:50" logs/application.log
```

## 📈 모니터링 포인트

### 1. 결근 처리 건수
- 평소보다 많으면 → 시스템 문제 or 출근율 저하
- 0명이면 → 정상 or 공휴일

### 2. 자동 퇴근 처리 건수
- 많으면 → 직원들이 퇴근 버튼을 깜빡함
- 교육 필요

### 3. 근무 시간
- 자동 퇴근 시 14시간 이상 → 야근 빈번
- 업무 부하 분석 필요

## 🔧 트러블슈팅

### Q1: 스케줄러가 실행 안 됨
**확인사항:**
- `@EnableScheduling` 있는지 확인
- Application 재시작
- 로그에 "스케줄러 시작" 메시지 있는지 확인

### Q2: 주말에도 실행됨
**해결:**
- Cron 표현식에 `MON-FRI` 확인
- `isWeekend()` 메서드 확인

### Q3: 중복 결근 처리됨
**원인:**
- `existsByEmployeeAndCheckInBetween` 쿼리 확인
- 날짜 범위(00:00 ~ 23:59) 확인

### Q4: 자동 퇴근 시간이 이상함
**확인:**
- 서버 타임존 확인
- `AUTO_CHECKOUT_TIME` 상수 확인

## 🎉 요약

- ✅ **평일 오전 10시 01분**: 출근 안 한 직원 자동 결근 처리
- ✅ **평일 밤 11시 50분**: 퇴근 안 찍은 직원 자동 퇴근 처리
- ✅ **매시간 정각**: 근무 상태 모니터링 (로그)
- ✅ **주말 제외**: 토, 일요일은 자동 실행 안 함
- ✅ **DB 계속 돌아감**: Spring Scheduler가 백그라운드에서 자동 실행

이제 출퇴근 관리가 완전 자동화됩니다! 🚀
